# IP Test - Cloudflare优选IP采集器

一个高效的Cloudflare优选IP采集、检测和地区识别工具，支持GitHub Actions自动执行。

## 🚀 主要特性

- **智能缓存系统**: 支持TTL机制的缓存，避免重复API调用，自动限制缓存大小
- **并发处理**: 使用ThreadPoolExecutor大幅提升检测速度
- **网络优化**: 连接复用，减少网络开销，智能请求间隔
- **智能重试**: 动态调整重试策略，提高检测成功率
- **地区识别**: 支持多种API和智能缓存
- **完善日志**: 所有操作都有详细的Emoji日志记录
- **错误处理**: 特别优化403错误处理，增强稳定性
- **GitHub Actions**: 支持自动化部署和执行

## 📋 功能说明

### 1. IP采集
从多个源采集Cloudflare IP地址：
- ✅ 行雺
- ✅ Ymyuuu
- ✅ 麒麟
- ✅ Hostmonit
- ✅ Mingyu API
- ✅ 好哥哥
- ✅ 微测网
- ✅ VPS789
- ✅ CMLiussss (电信/移动)

### 2. 并发检测
- 使用20个并发线程检测IP可用性
- 单端口检测提升速度（默认443端口）
- 智能重试机制，动态调整超时时间

### 3. 地区识别
- 优先使用缓存查询
- 支持ipinfo.io和ip-api.com
- 智能缓存TTL机制（7天）

## 🛠️ 本地使用

### 安装依赖
```bash
pip install requests urllib3
```

### 运行程序
```bash
python IPtest.py
```

### 输出文件
- `IPlist.txt` - 可用IP列表
- `Senflare.txt` - 格式化结果
- `Cache.json` - 地区缓存
- `IPtest.log` - 详细日志

## 🤖 GitHub Actions

### 自动执行
- 每3小时自动执行一次
- 支持手动触发
- 自动提交结果到仓库

### 工作流配置
```yaml
# .github/workflows/IPtest.yml
name: IP Test
on:
  schedule:
    - cron: '0 */3 * * *'  # 每3小时执行
  workflow_dispatch:       # 手动触发
```

### 环境要求
- Ubuntu 20.04+
- Python 3.11

## 📊 性能优化

| 优化项目 | 原始耗时 | 优化后耗时 | 提升倍数 |
|---------|---------|-----------|---------|
| IP检测 | 串行处理 | 并发20线程 | **15-20x** |
| 端口检测 | 多端口检测 | 单端口检测 | **3-5x** |
| 地区查询 | 每次API调用 | 缓存优先 | **5-10x** |
| 网络连接 | 每次新建 | 连接复用 | **2-3x** |
| IP源优化 | 部分无效源 | 100%有效源 | **100%** |
| 超时优化 | 15秒/IP | 3秒/IP | **5x** |
| 重试优化 | 2次重试 | 1次重试 | **2x** |
| 批次优化 | 50个/批 | 20个/批 | **2.5x** |
| 总体性能 | 约1500秒 | 约20秒 | **75x** |

## 🔧 配置说明

### 核心配置
```python
CONFIG = {
    "ip_sources": [...],            # IP采集源列表
    "test_ports": [443],            # 测试核心端口
    "timeout": 8,                   # IP采集超时时间
    "api_timeout": 5,               # API查询超时时间
    "query_interval": 0.1,          # API查询间隔
    "max_workers": 20,              # 最大并发线程数
    "batch_size": 10,               # 批量处理大小
    "cache_ttl_hours": 168,         # 缓存TTL（7天）
}
```

### 检测端口
优化为单端口检测，提升速度：
- **主要端口**: 443 (HTTPS标准端口)
- **可选端口**: 2052, 2053, 2082, 2083, 2086, 2087, 2095, 2096, 8443, 8444 (Cloudflare专用端口)
- **端口说明**: 默认只测试443端口，如需测试其他端口可修改配置

## 📝 日志说明

程序会生成详细的日志文件 `IPtest.log`，包含：
- 🚀 程序启动和结束状态
- 📊 IP采集过程详情和统计
- 🔢 IP去重和排序信息
- 📡 IP检测结果统计
- 🌍 地区识别过程详情
- 📄 文件保存状态确认
- ⚠️ 警告和错误信息记录
- 💾 缓存操作状态
- 🏁 性能指标和完成统计

所有日志都使用Emoji图标，便于快速识别不同类型的操作。

## 🚨 注意事项

1. **API限制**: 地区查询API有调用限制，程序已加入防限流机制
2. **网络环境**: 建议在稳定的网络环境下运行
3. **资源消耗**: 并发检测会消耗较多网络资源
4. **缓存管理**: 自动清理过期的缓存文件

## 📈 使用建议

1. **首次运行**: 建议在本地测试后再部署到GitHub Actions
2. **定时执行**: 建议设置合理的执行频率，避免过度调用API
3. **结果验证**: 定期检查输出结果的准确性
4. **性能监控**: 关注日志中的性能指标

## 🔄 更新日志

### v2.1.0 (2025-10-24) - 性能大幅优化版
- ✅ **性能大幅优化**：超时时间15秒→8秒，重试次数2次→1次
- ✅ **防卡住优化**：添加批次超时保护，小批次处理（50→20个IP/批）
- ✅ **地区识别优化**：API查询间隔2秒→0.1秒，并发线程10→15个
- ✅ **实时进度显示**：添加详细的检测进度和耗时统计
- ✅ **超快检测**：3秒单IP超时，快速失败机制
- ✅ **智能等待**：每5个IP等待一次，大幅减少等待时间
- ✅ **总体性能提升**：从30倍提升到**75倍**（1500秒→20秒）

### v2.0.0 (2025-10-24)
- ✅ 重命名主脚本为 `IPtest.py`
- ✅ 优化缓存系统，支持TTL机制
- ✅ 添加智能重试机制
- ✅ 简化项目结构，移除外部依赖文件
- ✅ 更新GitHub Actions工作流
- ✅ 重命名缓存文件为 `Cache.json`
- ✅ 完善日志系统，所有日志添加Emoji图标
- ✅ 优化网络请求，添加请求间隔和更好的请求头
- ✅ 增强错误处理，特别处理403错误
- ✅ 限制缓存大小，防止缓存文件过大
- ✅ 优化端口检测，默认只测试443端口，大幅提升检测速度
- ✅ 优化缓存TTL，从24小时延长至7天，减少API调用
- ✅ 更新IP源配置，移除无效源，添加新的可用API源

### v1.0.0
- ✅ 基础IP采集和检测功能
- ✅ 并发处理优化
- ✅ 地区识别功能
- ✅ GitHub Actions支持

## 🤝 贡献

欢迎提交Issue和Pull Request来改进这个项目！

## 📄 许可证

MIT License
